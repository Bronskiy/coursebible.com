{"version":3,"sources":["RedactorInput.js"],"names":["window","livePreviewHideFullscreen","$","Craft","RedactorInput","Garnish","Base","extend","id","linkOptions","volumes","elementSiteId","redactorConfig","$textarea","redactor","linkOptionModals","init","settings","this","transforms","lang","redactorLang","direction","orientation","imageUpload","fileUpload","plugins","removeNewLines","push","buttons","index","inArray","splice","lowestListButtonIndex","oldListButtons","i","length","callbacks","started","handleRedactorInit","focus","onEditorFocus","bind","blur","onEditorBlur","contextbar","showContextBar","initRedactor","selector","toolbarFixed","target","closest","toolbarFixedTarget","currentInstance","$R","toolbarButtons","toolbar","getButtonsKeys","indexOf","plugin","craftAssetImages","overrideButton","addButton","setTransforms","setVolumes","setElementSiteId","craftAssetFiles","craftEntryLinks","setLinkOptions","livePreview","on","ev","addClass","removeClass","onInitRedactor","container","getElement","leaveFullscreetOnSaveShortcut","opts","scrollPageOnReady","$doc","ready","trigger","fullscreen","close","cp","proxy","isOpen","replaceRedactorButton","key","title","previousButton","getButton","icon","$icon","get","placeholderKey","placeholder","addButtonAfter","remove","button","setIcon","e","justResized","current","selection","getCurrent","data","inspector","parse","repositionContextBar","top","clientY","$contextbar","height","position","left","clientX","width","css","isFigcaption","isComponentType","node","getComponent","$img","find","matches","attr","match","assetId","postActionRequest","success","image-editor","api","args","edit","set","jQuery"],"mappings":"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","file":"RedactorInput.min.js","sourcesContent":["window.livePreviewHideFullscreen = false;\n\n(function($) {\n    /** global: Craft */\n    /** global: Garnish */\n    /**\n     * Redactor input class\n     */\n    Craft.RedactorInput = Garnish.Base.extend(\n        {\n            id: null,\n            linkOptions: null,\n            volumes: null,\n            elementSiteId: null,\n            redactorConfig: null,\n\n            $textarea: null,\n            redactor: null,\n            linkOptionModals: null,\n\n            init: function(settings) {\n                this.id = settings.id;\n                this.linkOptions = settings.linkOptions;\n                this.volumes = settings.volumes;\n                this.transforms = settings.transforms;\n                this.elementSiteId = settings.elementSiteId;\n                this.redactorConfig = settings.redactorConfig;\n\n                this.linkOptionModals = [];\n\n                if (!this.redactorConfig.lang) {\n                    this.redactorConfig.lang = settings.redactorLang;\n                }\n\n                if (!this.redactorConfig.direction) {\n                    this.redactorConfig.direction = (settings.direction || Craft.orientation);\n                }\n\n                this.redactorConfig.imageUpload = false;\n                this.redactorConfig.fileUpload = false;\n\n                // Prevent a JS error when calling core.destroy() when opts.plugins == false\n                if (typeof this.redactorConfig.plugins !== typeof []) {\n                    this.redactorConfig.plugins = [];\n                }\n\n                // Prevent Redactor from saving block elements inconsistently\n                if (typeof this.redactorConfig.removeNewLines === 'undefined') {\n                    this.redactorConfig.removeNewLines = true;\n                }\n\n                this.redactorConfig.plugins.push('craftAssetImages');\n                this.redactorConfig.plugins.push('craftAssetFiles');\n                this.redactorConfig.plugins.push('craftEntryLinks');\n                this.redactorConfig.plugins.push('craftAssetImageEditor');\n\n                // Redactor I/II config setting normalization\n                if (this.redactorConfig.buttons) {\n                    var index;\n\n                    // buttons.formatting => buttons.format\n                    if ((index = $.inArray('formatting', this.redactorConfig.buttons)) !== -1) {\n                        this.redactorConfig.buttons.splice(index, 1, 'format');\n                    }\n\n                    // buttons.unorderedlist/orderedlist/undent/indent => buttons.lists\n                    var oldListButtons = ['unorderedlist', 'orderedlist', 'undent', 'indent'],\n                        lowestListButtonIndex;\n\n                    for (var i = 0; i < oldListButtons.length; i++) {\n                        if ((index = $.inArray(oldListButtons[i], this.redactorConfig.buttons)) !== -1) {\n                            this.redactorConfig.buttons.splice(index, 1);\n\n                            if (typeof lowestListButtonIndex === 'undefined' || index < lowestListButtonIndex) {\n                                lowestListButtonIndex = index;\n                            }\n                        }\n                    }\n\n                    if (typeof lowestListButtonIndex !== 'undefined') {\n                        this.redactorConfig.buttons.splice(lowestListButtonIndex, 0, 'lists');\n                    }\n                }\n\n                // Define our callbacks\n                this.redactorConfig.callbacks = {\n                    started: Craft.RedactorInput.handleRedactorInit,\n                    focus: this.onEditorFocus.bind(this),\n                    blur: this.onEditorBlur.bind(this),\n                    contextbar: this.showContextBar.bind(this)\n                };\n\n                // Initialize Redactor\n                this.initRedactor();\n            },\n\n            initRedactor: function() {\n                var selector = '#' + this.id;\n                this.$textarea = $(selector);\n\n                if (typeof this.redactorConfig.toolbarFixed === 'undefined' || this.redactorConfig.toolbarFixed) {\n                    // Set the toolbarFixedTarget depending on the context\n                    var target = this.$textarea.closest('#content, .lp-editor');\n                    if (target.length) {\n                        this.redactorConfig.toolbarFixedTarget = target;\n                    }\n                }\n\n                Craft.RedactorInput.currentInstance = this;\n                this.$textarea.redactor(this.redactorConfig);\n\n                this.redactor = $R(selector);\n\n                if (typeof this.redactorConfig.buttons === 'undefined') {\n                    this.redactorConfig.buttons = [];\n                }\n\n                var toolbarButtons = this.redactor.toolbar.getButtonsKeys();\n\n                if (this.redactorConfig.buttons.indexOf('image') !== -1) {\n                    if (toolbarButtons.indexOf('image') !== -1) {\n                        this.redactor.plugin.craftAssetImages.overrideButton('image');\n                    } else {\n                        this.redactor.plugin.craftAssetImages.addButton('image', this.redactorConfig.buttons.indexOf('image'));\n                    }\n                    this.redactor.plugin.craftAssetImages.setTransforms(this.transforms);\n                    this.redactor.plugin.craftAssetImages.setVolumes(this.volumes);\n                    this.redactor.plugin.craftAssetImages.setElementSiteId(this.elementSiteId);\n                }\n\n                if (this.redactorConfig.buttons.indexOf('file') !== -1) {\n                    if (toolbarButtons.indexOf('file') !== -1) {\n                        this.redactor.plugin.craftAssetFiles.overrideButton('file');\n                    } else {\n                        this.redactor.plugin.craftAssetFiles.addButton('file', this.redactorConfig.buttons.indexOf('file'));\n                    }\n                    this.redactor.plugin.craftAssetFiles.setVolumes(this.volumes);\n                    this.redactor.plugin.craftAssetFiles.setElementSiteId(this.elementSiteId);\n                }\n\n                if (toolbarButtons.indexOf('link') !== -1) {\n                    this.redactor.plugin.craftEntryLinks.setElementSiteId(this.elementSiteId);\n\n                    if (this.linkOptions.length) {\n                        this.redactor.plugin.craftEntryLinks.setLinkOptions(this.linkOptions);\n                    }\n                }\n\n                if (this.redactorConfig.plugins.indexOf('fullscreen') !== -1 && typeof Craft.livePreview != \"undefined\" && window.livePreviewHideFullscreen === false) {\n                    window.livePreviewHideFullscreen = true;\n                    Craft.livePreview.on('beforeEnter', function (ev) {\n                       $('a.re-button.re-fullscreen').addClass('hidden');\n                    });\n                    Craft.livePreview.on('beforeExit', function (ev) {\n                        $('a.re-button.re-fullscreen').removeClass('hidden');\n                    });\n                }\n\n                delete Craft.RedactorInput.currentInstance;\n            },\n\n            onInitRedactor: function(redactor) {\n\n                this.redactor = redactor;\n\n                // Add the .focusable-input class for Craft.CP\n                this.redactor.container.getElement().addClass('focusable-input');\n\n                this.leaveFullscreetOnSaveShortcut();\n\n                if (this.redactor.opts.toolbarFixed && !Craft.RedactorInput.scrollPageOnReady) {\n                    Garnish.$doc.ready(function() {\n                        Garnish.$doc.trigger('scroll');\n                    });\n\n                    Craft.RedactorInput.scrollPageOnReady = true;\n                }\n            },\n\n            onEditorFocus: function() {\n                this.redactor.container.getElement().addClass('focus');\n                this.redactor.container.getElement().trigger('focus');\n            },\n\n            onEditorBlur: function() {\n                this.redactor.container.getElement().removeClass('focus');\n                this.redactor.container.getElement().trigger('blur');\n            },\n\n            leaveFullscreetOnSaveShortcut: function() {\n                if (typeof this.redactor.plugin.fullscreen !== 'undefined' && typeof this.redactor.plugin.fullscreen.close === 'function') {\n                    Craft.cp.on('beforeSaveShortcut', $.proxy(function() {\n                        if (this.redactor.plugin.fullscreen.isOpen) {\n                            this.redactor.plugin.fullscreen.close();\n                        }\n                    }, this));\n                }\n            },\n\n            replaceRedactorButton: function(key, title) {\n                var previousButton = this.redactor.toolbar.getButton(key);\n\n                // Ignore if the button isn't in use\n                if (!previousButton) {\n                    return;\n                }\n\n                var icon = previousButton.$icon.get(0);\n\n                var placeholderKey = key+'_placeholder';\n                var placeholder = this.redactor.toolbar.addButtonAfter(key, placeholderKey, {title: title});\n                previousButton.remove();\n\n                // Create the new button\n                var button = this.redactor.toolbar.addButtonAfter(placeholderKey, key, {title: title});\n                placeholder.remove();\n\n                button.setIcon(icon);\n\n                return button;\n            },\n\n            showContextBar: function(e, contextbar) {\n                if (this.justResized)\n                {\n                    this.justResized = false;\n                    return;\n                }\n\n                var current = this.redactor.selection.getCurrent();\n                var data = this.redactor.inspector.parse(current);\n\n                var repositionContextBar = function (e, contextbar) {\n                    var top = e.clientY - contextbar.$contextbar.height() - 10;\n                    var left = e.clientX - contextbar.$contextbar.width() / 2;\n\n                    var position = {\n                        left: left + 'px',\n                        top: top + 'px'\n                    };\n\n                    contextbar.$contextbar.css(position);\n                };\n\n                if (!data.isFigcaption() && data.isComponentType('image'))\n                {\n                    var node = data.getComponent();\n                    var $img  = $(node).find('img');\n                    if ($img.length === 1) {\n                        var matches = matches = $img.attr('src').match(/#asset:(\\d+)/i);\n                        if (matches) {\n                            var assetId = matches[1];\n                            Craft.postActionRequest('redactor', {assetId: assetId}, function (data) {\n                                if (data.success) {\n                                    var buttons = {\n                                        \"image-editor\": {\n                                            title: this.redactor.lang.get('image-editor'),\n                                            api: 'plugin.craftAssetImageEditor.open',\n                                            args: assetId\n                                        },\n                                        \"edit\": {\n                                            title: this.redactor.lang.get('edit'),\n                                            api: 'module.image.open'\n                                        },\n                                        \"remove\": {\n                                            title: this.redactor.lang.get('delete'),\n                                            api: 'module.image.remove',\n                                            args: node\n                                        }\n                                    };\n\n                                    contextbar.set(e, node, buttons);\n                                }\n\n                                repositionContextBar(e, contextbar);\n                            }.bind(this));\n                        }\n                    }\n\n                }\n\n                repositionContextBar(e, contextbar);\n            }\n        },\n        {\n            handleRedactorInit: function() {\n                // `this` is the current Redactor instance.\n                // `Craft.RedactorInput.currentInstance` is the current RedactorInput instance\n                Craft.RedactorInput.currentInstance.onInitRedactor(this);\n            }\n        });\n})(jQuery);\n"]}